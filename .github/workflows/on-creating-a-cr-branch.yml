name: Update Project Status on Branch Creation

on:
  create:
    branches:
      - '*'

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    if: contains(github.ref_name, '-cr-')
    
    steps:
      - name: Update project status
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          PROJECT_ID: "PVT_kwHOBJsXdM4Arizg"
          STATUS_FIELD_ID: "PVTSSF_lAHOBJsXdM4ArizgzginKI8"
          COMMITTED_OPTION_ID: "30c5553b"
        run: |
          ISSUE_NUMBER=$(echo "${{ github.ref_name }}" | sed -n 's/^\([0-9]\+\)-cr-.*/\1/p')
          
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  projectItems(first: 1) {
                    nodes {
                      id
                    }
                  }
                }
              }
            }' -f owner=${{ github.repository_owner }} -f repo=${{ github.event.repository.name }} -f number=$ISSUE_NUMBER --jq '.data.repository.issue.projectItems.nodes[0].id')
          
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { 
                    singleSelectOptionId: $optionId
                  }
                }
              ) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=$PROJECT_ID -f itemId=$ITEM_ID -f fieldId=$STATUS_FIELD_ID -f optionId=$COMMITTED_OPTION_ID
